# mise configuration for ZMK Charybdis firmware development
# https://mise.jdx.dev/

[tools]
python = "3.11"
cmake = "latest"
ninja = "latest"

[env]
# Zephyr workspace directory
ZEPHYR_BASE = "{{ config_root }}/zephyr"
ZMK_WORKSPACE = "{{ config_root }}"

[tasks.setup]
description = "Initialize ZMK workspace and install dependencies"
run = """
#!/usr/bin/env bash
set -e

echo "üì¶ Installing Python dependencies..."
pip install west

echo "üîß Initializing ZMK workspace..."
if [ ! -d ".west" ]; then
    west init -l config
fi

echo "‚¨áÔ∏è Updating ZMK modules..."
west update

echo "üì• Installing Zephyr Python dependencies..."
pip install -r zephyr/scripts/requirements.txt

echo "üîß Installing Zephyr SDK (if not present)..."
ZEPHYR_SDK_VERSION="0.17.0"
ZEPHYR_SDK_INSTALL_DIR="$HOME/.local/zephyr-sdk-${ZEPHYR_SDK_VERSION}"

if [ ! -d "$ZEPHYR_SDK_INSTALL_DIR" ]; then
    echo "Downloading Zephyr SDK ${ZEPHYR_SDK_VERSION}..."
    cd /tmp
    wget -q "https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v${ZEPHYR_SDK_VERSION}/zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64_minimal.tar.xz"
    tar xf "zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64_minimal.tar.xz" -C "$HOME/.local/"
    cd "$ZEPHYR_SDK_INSTALL_DIR"
    ./setup.sh -t arm-zephyr-eabi -h -c
    rm -f "/tmp/zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64_minimal.tar.xz"
    echo "Zephyr SDK installed to $ZEPHYR_SDK_INSTALL_DIR"
else
    echo "Zephyr SDK already installed at $ZEPHYR_SDK_INSTALL_DIR"
fi

echo "üì¶ Registering Zephyr CMake package..."
cd "$OLDPWD"
west zephyr-export

echo "‚úÖ Setup complete! Run 'mise run build:left' or 'mise run build:right' to build firmware."
"""

[tasks."build:left"]
description = "Build firmware for the left half (nice_nano)"
run = '''
#!/usr/bin/env bash
set -e
export ZEPHYR_BASE="$PWD/zephyr"
echo "üî® Building Charybdis LEFT..."
west build -s zmk/app -b nice_nano -- -DSHIELD=charybdis_left -DZMK_CONFIG="$PWD/config"
echo "‚úÖ Firmware ready: build/zephyr/zmk.uf2"
'''

[tasks."build:right"]
description = "Build firmware for the right half (nice_nano)"
run = '''
#!/usr/bin/env bash
set -e
export ZEPHYR_BASE="$PWD/zephyr"
echo "üî® Building Charybdis RIGHT..."
west build -s zmk/app -b nice_nano -- -DSHIELD=charybdis_right -DZMK_CONFIG="$PWD/config"
echo "‚úÖ Firmware ready: build/zephyr/zmk.uf2"
'''

[tasks."build:all"]
description = "Build firmware for both halves"
depends = ["build:left"]
run = '''
#!/usr/bin/env bash
set -e
export ZEPHYR_BASE="$PWD/zephyr"
# Move left firmware
mkdir -p firmware
cp build/zephyr/zmk.uf2 firmware/charybdis_left.uf2
echo "üìÅ Saved: firmware/charybdis_left.uf2"

# Build right
echo "üî® Building Charybdis RIGHT..."
west build -s zmk/app -b nice_nano -- -DSHIELD=charybdis_right -DZMK_CONFIG="$PWD/config"
cp build/zephyr/zmk.uf2 firmware/charybdis_right.uf2
echo "üìÅ Saved: firmware/charybdis_right.uf2"

echo "‚úÖ Both firmware files ready in ./firmware/"
'''

[tasks.clean]
description = "Clean build artifacts"
run = "rm -rf build"

[tasks.flash]
description = "Instructions for flashing firmware"
run = '''
#!/usr/bin/env bash
echo "üìù Flashing Instructions:"
echo ""
echo "1. Put your nice!nano into bootloader mode:"
echo "   - Double-tap the reset button"
echo "   - Or hold reset while connecting USB"
echo ""
echo "2. A USB drive named 'NICENANO' should appear"
echo ""
echo "3. Copy the .uf2 file to the drive:"
echo "   - LEFT:  cp firmware/charybdis_left.uf2 /media/$USER/NICENANO/"
echo "   - RIGHT: cp firmware/charybdis_right.uf2 /media/$USER/NICENANO/"
echo ""
echo "4. The keyboard will automatically reboot after copying"
'''
